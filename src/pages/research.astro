---
import Layout from "@/layouts/Layout.astro";
import Footer from "@/components/Footer.astro";
import Newletter from "@/components/Newletter.astro";
import "../styles/global.css";
import cover from "../../public/images/banner.webp";
import project1 from "../assets/project1.svg";
import projectcover from "../assets/wind-farms-fields.jpg";
import projectcovercover from "../assets/abstract-creative-3d-sphere-with-vegetation.jpg";
import projectbackgrond from "../assets/reseach_images/research.jpg";
import project4 from "../assets/reseach_images/Consultancy Projects.jpg";
import project5 from "../assets/reseach_images/Patents Filed.jpg";
import project6 from "../assets/reseach_images/Patents Granted.jpg";
import { centersData, researchProjectsData } from "../Data/research.js";
import { formatResearchProjects, truncateText } from "../utils/helpers.js";


const centers = centersData;
const researchProjects = [
  {
    ...researchProjectsData[0],
    image: project1,
  },
  {
    ...researchProjectsData[1],
    image: project4,
  },
  {
    ...researchProjectsData[2],
    image: project5,
  },
  {
    ...researchProjectsData[3],
    image: project6,
  }
];

const formattedProjects = formatResearchProjects(researchProjects);
---

<Layout title="School of Sustainability">
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <img
      src={cover.src}
      alt="School of Sustainability IIT Madras"
      class="w-full h-full sm:h-[100vh] md:h-[100vh] lg:h-[100vh] object-cover mt-18"
      loading="eager"
    />
    <div
      class="absolute left-4 sm:left-8 lg:left-12 xl:left-16 bottom-[-10px] sm:bottom-[-20px] lg:bottom-[-30px] xl:bottom-[-30px] bg-[#032A03] backdrop-blur-sm bg-opacity-95 p-4 sm:p-6 lg:p-8 w-[calc(100%-2rem)] sm:w-[calc(100%-4rem)] lg:w-2/3 xl:w-1/2 rounded-md shadow-lg z-10"
    >
      <p class="text-base sm:text-lg lg:text-xl text-white leading-relaxed p-5 rounded-md">
        Driving innovation for a sustainable future—our research empowers communities, informs policy, and creates solutions for the world's most pressing environmental and social challenges
      </p>
    </div>
    <div class="h-12 sm:h-16 lg:h-20 xl:h-24 bg-transparent"></div>
  </section>

  <!-- Navigation Links -->
  <nav class="mt-8 mb-8 sm:mb-12 md:mb-16 sm:mt-12 md:mt-16 lg:mt-20">
    <div
      class="container mx-auto flex flex-wrap justify-center items-center gap-3 sm:gap-5 text-base sm:text-lg md:text-xl text-[#3DAA6F]"
    >
      <a
        href="#research"
        class="hover:text-green-600 transition-colors cursor-pointer"
        >Research & Development</a
      >
      <span class="text-gray-400">|</span>
      <a href="#projects" class="hover:text-green-600 transition-colors cursor-pointer">Projects</a>
      <span class="text-gray-400">|</span>
      <a href="#centers" class="hover:text-green-600 transition-colors cursor-pointer">Affiliated Centers</a>
    </div>
  </nav>

  <!-- Research & Development Section -->
  <section id="research" class="container mx-auto px-4 py-12 sm:py-16 md:py-20">
    <h2 class="text-xl sm:text-2xl text-center md:text-3xl font-bold mb-6">
      Research & Development
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-4 lg:grid-cols-4 gap-6 sm:gap-8">
      {formattedProjects.map((project) => (
        <article class="bg-gray-100 rounded-xl overflow-hidden hover:shadow-lg transition-shadow group">
          <a
            href={project.url}
            target="_blank"
            rel="noopener noreferrer"
            class="block"
            data-project-id={project.id}
          >
            <img
              src={project.image.src}
              alt={project.title}
              class="w-full h-48 sm:h-56 md:h-64 object-cover p-4 group-hover:scale-105 transition-transform cursor-pointer rounded-3xl"
              loading="lazy"
            />
          </a>
          <div class="p-4 sm:p-6">
            <a
              href={project.url}
              target="_blank"
              rel="noopener noreferrer"
              class="text-base sm:text-lg font-medium  transition-colors block"
              data-project-id={project.id}
            >
              {project.title}
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- Projects Section -->
  <section id="projects" class="relative overflow-hidden pt-12 sm:pt-16 md:pt-20 bg-white">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 z-10 relative">
      <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-8 text-center text-gray-800">
        Projects
      </h2>
    </div>

    <img
      src={projectcover.src}
      alt="Wind farms project"
      class="w-full h-[40vh] sm:h-[50vh] md:h-[60vh] lg:h-[75vh] object-cover"
      loading="lazy"
    />

    <div class="absolute inset-0 flex flex-col justify-center items-center text-white px-4 sm:px-8 z-10 text-center">
      <p class="text-lg sm:text-xl md:text-2xl lg:text-3xl max-w-4xl leading-relaxed mb-6">
        Our projects tackle real-world sustainability challenges.<br />
        Led by students and experts, they create lasting impact.
      </p>
      <div class="relative w-full max-w-md sm:max-w-lg md:max-w-xl">
        <img
          src={projectcovercover.src}
          alt="3D sustainability visualization"
          class="w-full h-48 sm:h-56 md:h-64 object-cover rounded-xl shadow-2xl"
          loading="lazy"
        />
        <div class="absolute inset-2 sm:inset-4 flex flex-col justify-center items-center text-center">
          <p class="text-white text-sm sm:text-base md:text-lg font-medium mb-4 leading-tight">
            Explore real-world solutions in action.<br />
            Discover how our projects drive sustainability forward
          </p>
          <button
            id="viewProjectsBtn"
            class="bg-white text-black font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-200 text-sm sm:text-base"
          >
            VIEW PROJECTS
          </button>
        </div>
      </div>
    </div>
    <div class="h-12 sm:h-16 lg:h-20 xl:h-24 bg-transparent"></div>
  </section>

  <!--Affiliated Centers -->
  <section id="centers" class="py-12 sm:py-16 md:py-20 relative">
    <div class="container mx-auto px-4">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-4 sm:mb-0">
          Affiliated Centers
        </h2>
      </div>

      <!-- Background Image -->
      <div class="absolute inset-0 z-0">
        <img
          src={projectbackgrond.src}
          alt="Affiliated Centers background"
          class="w-full h-full object-cover opacity-70"
          loading="lazy"
        />
      </div>

      <!-- Centers Grid -->
      <div id="centersGrid" class="relative z-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6 transition-all duration-300">
        {centers.map((center) => (
          <div class="center-card relative bg-white/90 backdrop-blur-sm hover:bg-white/95 transition-all duration-300 p-3 sm:p-4 rounded-lg cursor-pointer group shadow-lg hover:shadow-xl border border-white/20"
               data-center-name={center.name.toLowerCase()}
               data-center-detail={center.detail.toLowerCase()}
               data-center-id={center.id}
               tabindex="0">
            
            <!-- Main Card Content -->
            <div class="card-content transition-all duration-300">
              <!-- Logo -->
              <div class="w-12 h-12 sm:w-14 sm:h-14 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden mx-auto mb-3">
                <img 
                  src={center.logo} 
                  alt={center.name} 
                  class="w-full h-full object-contain"
                  loading="lazy"
                />
              </div>
              
              <!-- Name -->
              <div class="text-center">
                <h3 class="text-xs sm:text-sm font-medium text-gray-800 line-clamp-2 leading-tight">
                  {center.name}
                </h3>
              </div>
            </div>

            {/* <!-- Centered Tooltip within Grid Area --> */}

            <div class="center-tooltip absolute bg-white border border-gray-200 rounded-xl shadow-2xl p-6 w-80 opacity-0 invisible transition-all duration-300 pointer-events-none z-50 scale-95">
              
              {/* <!-- Close button --> */}
              <button class="tooltip-close absolute top-4 right-4 w-8 h-8 bg-gray-800 text-white rounded-full text-sm flex items-center justify-center hover:bg-gray-900 transition-colors z-10">
                ×
              </button>
              
              {/* <!-- Tooltip Header --> */}
              <div class="flex items-center gap-4 mb-6 pr-10">
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                  <img 
                    src={center.logo} 
                    alt={center.name} 
                    class="w-full h-full object-contain"
                    loading="lazy"
                  />
                </div>
                <h4 class="font-bold text-gray-800 text-lg leading-tight">
                  {center.name}
                </h4>
              </div>

              {/* <!-- Details Section --> */}
              <div class="space-y-4">
                {/* <!-- Center Type --> */}
                <div class="border-b border-gray-100 pb-3">
                  <div class="text-sm text-gray-600 mb-2 font-medium">Center Type</div>
                  <div class="text-base font-medium text-gray-800">Research & Development</div>
                </div>
                
                {/* <!-- Focus Area --> */}
                <div class="border-b border-gray-100 pb-3">
                  <div class="text-sm text-gray-600 mb-2 font-medium">Focus Area</div>
                  <div class="text-base font-medium text-gray-800">Sustainability Sciences</div>
                </div>
                
                {/* <!-- Description --> */}
                <div class="border-b border-gray-100 pb-3">
                  <div class="text-sm text-gray-600 mb-2 font-medium">Description</div>
                  <div class="text-base text-gray-700 leading-relaxed max-h-32 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                    {center.detail}
                  </div>
                </div>
                
                {/* <!-- Quick Actions --> */}
                <div class="pt-2">
                  <div class="text-sm text-gray-600 mb-3 font-medium">Quick Actions</div>
                  <div class="flex gap-3">
                    <a
                      href={center.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors font-medium"
                    >
                      Visit Center →
                    </a>
                    <button class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 text-sm rounded-lg hover:bg-gray-200 transition-colors font-medium">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                      </svg>
                      Share
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <br />
  <Newletter />
  <Footer />
</Layout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .center-tooltip {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    z-index: 50;
    max-width: 320px;
    min-width: 280px;
  }

  #centersGrid:has(.center-card:hover) .center-card:not(:hover) {
    filter: blur(4px);
    opacity: 0.4;
    transform: scale(0.95);
  }

  #centersGrid:has(.center-card:hover) .center-card:hover {
    filter: none;
    opacity: 1;
    transform: scale(1.02);
    z-index: 60;
  }

  .center-card:hover .center-tooltip,
  .center-card:focus-within .center-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
    pointer-events: auto;
  }

  /* Position tooltip relative to the grid container */
  #centersGrid {
    position: relative;
  }

  .center-card:hover .center-tooltip {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
  }

  /* Custom scrollbar for tooltip content */
  .scrollbar-thin {
    scrollbar-width: thin;
    scrollbar-color: #d1d5db #f3f4f6;
  }
  
  .scrollbar-thin::-webkit-scrollbar {
    width: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 2px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 2px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }

  /* Responsive behavior for grid-centered tooltip */
  @media (max-width: 768px) {
    .center-tooltip {
      width: 90vw !important;
      max-width: 90vw !important;
      padding: 1.5rem !important;
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) scale(1) !important;
    }

    #centersGrid:has(.center-card:hover) .center-card:not(:hover) {
      filter: blur(2px);
      opacity: 0.3;
    }
  }

  /* Animation for grid-centered tooltip */
  @keyframes gridTooltipSlideIn {
    from {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }

  .center-card:hover .center-tooltip {
    animation: gridTooltipSlideIn 0.3s ease-out;
  }

  /* Additional CSS for blur effects */
  #centersGrid.has-active-tooltip .center-card:not(.active-tooltip-card) {
    filter: blur(4px);
    opacity: 0.4;
    transform: scale(0.95);
  }

  #centersGrid.has-active-tooltip .center-card.active-tooltip-card {
    filter: none;
    opacity: 1;
    transform: scale(1.02);
    z-index: 60;
  }

  /* Fallback for browsers that don't support :has() selector */
  @supports not selector(:has(*)) {
    .center-card:hover ~ .center-card,
    .center-card:hover ~ * .center-card {
      filter: blur(4px);
      opacity: 0.4;
      transform: scale(0.95);
    }
  }

  /* Focus states for accessibility */
  .center-card:focus {
    outline: 2px solid #3daa6f;
    outline-offset: 2px;
  }

  .center-card:focus:not(:focus-visible) {
    outline: none;
  }

  /* Animation for grid-centered tooltip */
  @keyframes gridTooltipSlideIn {
    from {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }

  .center-card:hover .center-tooltip {
    animation: gridTooltipSlideIn 0.3s ease-out;
  }

  /* Smooth transitions for all cards */
  .center-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Enhanced button styles */
  .tooltip-close:hover {
    background-color: #ef4444;
    transform: scale(1.1);
  }

  /* Prevent text selection on tooltip */
  .center-tooltip {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  /* Allow text selection in description */
  .center-tooltip .text-sm.text-gray-700 {
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
  }
</style>

<script>
  // Import utility functions for client-side functionality
  import { scrollToSection, handleExternalLink, trackEvent } from "../utils/helpers.js";

  // Declare activeTooltip variable for tooltip management
  let activeTooltip = null;
  
  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Handle smooth scrolling for navigation links
    const navLinks = document.querySelectorAll('nav a[href^="#"]');
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        scrollToSection(targetId);
      });
    });

    // Handle external link tracking
    const externalLinks = document.querySelectorAll('a[target="_blank"]');
    externalLinks.forEach(link => {
      link.addEventListener('click', function() {
        const url = this.getAttribute('href');
        const linkName = this.textContent.trim() || this.getAttribute('data-center-id') || this.getAttribute('data-project-id');
        trackEvent('external_link_click', { url, link_name: linkName });
      });
    });

    });

    // Close tooltips on scroll 
    window.addEventListener('scroll', function() {
      if (activeTooltip) {
        hideGridCenteredTooltip(activeTooltip);
      }
    });

    // Handle window resize to reposition tooltip
    window.addEventListener('resize', function() {
      if (activeTooltip) {
        const activeCard = document.querySelector('.active-tooltip-card');
        if (activeCard) {
          // Reposition the tooltip
          const gridRect = centersGrid.getBoundingClientRect();
          const centerX = gridRect.left + gridRect.width / 2;
          const centerY = gridRect.top + gridRect.height / 2;
          
          activeTooltip.style.left = centerX + 'px';
          activeTooltip.style.top = centerY + 'px';
        }
      }
    });

    // View Projects button
    const viewProjectsBtn = document.getElementById('viewProjectsBtn');
    if (viewProjectsBtn) {
      viewProjectsBtn.addEventListener('click', function() {
        scrollToSection('research');
        trackEvent('view_projects_click', { source: 'hero_section' });
      });
    }

    // Search functionality (if search input exists)
    const searchInput = document.getElementById('centerSearch');
    const centersGrid = document.getElementById('centersGrid');
    const noResults = document.getElementById('noResults');
    const centerCardsList = document.querySelectorAll('.center-card');

    if (searchInput) {
      searchInput.addEventListener('input', function() {      
        const searchTerm = this.value.toLowerCase().trim();
        let visibleCount = 0;

        centerCardsList.forEach(card => {
          const name = card.getAttribute('data-center-name');
          const detail = card.getAttribute('data-center-detail');
          
          if (name.includes(searchTerm) || detail.includes(searchTerm)) {
            card.style.display = 'block';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Show/hide no results message
        if (noResults) {
          if (visibleCount === 0) {
            noResults.classList.remove('hidden');
          } else {
            noResults.classList.add('hidden');
          }
        }
      });
    }
;

function hideGridCenteredTooltip(activeTooltip: any) {
throw new Error("Function not implemented.");
}
</script>